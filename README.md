# Singbox as service

Проект для управления [sing-box](https://github.com/SagerNet/sing-box) как службой Windows с возможностью маршрутизации трафика по настраиваемым правилам.

## Особенности

- Управление sing-box как службой Windows (установка, запуск, остановка, удаление)
- Поддержка двух режимов работы: TUN и Proxy
- Поддержка DNS-over-HTTPS через Google DNS
- Маршрутизация трафика на основе правил для различных сервисов (Discord, YouTube, TikTok)
- Автоматическое обновление правил антиблокировки через remote ruleset
- Поддержка VLESS + Reality для безопасного соединения
- TUN интерфейс для системной маршрутизации трафика

## Структура проекта

```
VPN-Service-Sample/
├── sing-box/                       # Основная директория
│   ├── rules/                      # Правила маршрутизации
│   │   ├── custom-rules.json       # Пользовательские правила
│   │   ├── geosite-*.srs           # Бинарные файлы правил для сайтов
│   │   └── geoip-*.srs             # Бинарные файлы правил для IP
│   ├── config-tun.json             # Конфиг для режима TUN
│   ├── config-proxy.json           # Конфиг для режима Proxy
│   ├── sing-box.exe                # Исполняемый файл sing-box
│   └── singbox-service.xml         # Конфигурация службы Windows
├── install-service.bat             # Установка службы
├── uninstall-service.bat           # Удаление службы
├── start-service.bat               # Запуск службы
├── stop-service.bat                # Остановка службы
├── restart-service.bat             # Перезапуск службы
├── status-service.bat              # Проверка статуса службы
├── change-mode.bat                 # Переключение между режимами TUN и Proxy
├── show-mode.bat                   # Отображение текущего режима
└── start-once-without-service.bat  # Запуск без установки службы
```

## Установка

1. Клонируйте репозиторий в удобное место на вашем компьютере. **ВАЖНО:** путь к папке проекта не должен содержать пробелов
2. Выберите нужный режим работы с помощью `change-mode.bat`
3. Настройте параметры подключения в `config-tun.json` и `config-proxy.json`. Для этого есть два способа:
   - Экспортируйте конфигурацию из NekoBox и скопируйте из неё секцию outbounds
   - Воспользуйтесь генератором конфигурации: [XKeen Config Generator](https://corvus-malus.github.io/XKeen-Config-Generator/)
4. Бесплатный VLESS можно получить тут: [Aeza VLESS Generator](https://github.com/vernette/aeza-vless-generator)
5. Запустите `install-service.bat` от имени администратора для установки службы

## Управление службой и режимами

### Управление службой

- `install-service.bat` - установка службы Windows
- `uninstall-service.bat` - удаление службы
- `start-service.bat` - запуск службы
- `stop-service.bat` - остановка службы
- `restart-service.bat` - перезапуск службы
- `status-service.bat` - проверка статуса службы
- `start-once-without-service.bat` - запуск sing-box без установки службы

### Управление режимами

- `change-mode.bat` - переключение между режимами TUN и Proxy и перезапуск службы
- `show-mode.bat` - отображение текущего активного режима

## Конфигурация

### Основные компоненты конфигурационных файлов:

- DNS настройки с поддержкой DNS-over-HTTPS
- TUN интерфейс для системной маршрутизации (только в режиме TUN)
- Несколько исходящих соединений (outbounds) для разных сервисов
- Правила маршрутизации на основе геолокации и пользовательских списков
- Автоматическое обновление правил антиблокировки

### Служба Windows

Служба настроена со следующими параметрами:

- Автоматический перезапуск при сбоях (через 10 секунд)
- Сброс счетчика сбоев каждый час
- Нормальный приоритет процесса
- Тайм-аут остановки службы: 15 секунд
- Ротация логов по размеру (10 МБ, хранение 8 файлов)

## Требования

- Windows 7/8/10/11
- Права администратора для управления службой
- Поддержка TUN-интерфейса в системе (для режима TUN)

## Безопасность

- Используется VLESS + Reality для безопасного соединения
- Строгая маршрутизация через TUN-интерфейс (в режиме TUN)
- Блокировка UDP на порту 443
- Защита от DNS-утечек через DNS-over-HTTPS

## Логирование

- Основной лог: `box.log`
- Логи службы: `singbox-service.err.log`, `singbox-service.out.log`, `singbox-service.wrapper.log`
- Уровень логирования: warning (можно изменить в конфигурационных файлах)
